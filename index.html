<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PROHORECA | Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0e0e0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4345/4345573.png">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0e0e0f;
            --surface: #161618;
            --card: #1e1e21;
            --border: #2a2a2e;
            --accent: #f5a623;
            --text: #e8e8ea;
            --muted: #888890;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-top: env(safe-area-inset-top, 0px);
            --green: #2ecc71;
            --red: #e74c3c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'IBM Plex Sans', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .bebas { font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }

        header {
            padding: calc(20px + var(--safe-top)) 20px 10px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 22px; color: var(--accent); }
        .header-btns { display: flex; gap: 15px; align-items: center; }

        main { flex: 1; overflow-y: auto; padding: 15px 15px 120px; position: relative; }

        /* --- TASK CARD & SWIPE --- */
        .task-container {
            position: relative;
            margin-bottom: 12px;
            border-radius: 14px;
            overflow: hidden;
            background: var(--card);
            touch-action: pan-y;
        }

        .swipe-action {
            position: absolute;
            top: 0; bottom: 0; width: 100%;
            display: flex; align-items: center;
            padding: 0 25px; font-weight: bold; font-size: 14px;
            color: white; z-index: 1;
        }
        .swipe-done { background: var(--green); justify-content: flex-start; }
        .swipe-delete { background: var(--red); justify-content: flex-end; }

        .task-card {
            background: var(--card);
            padding: 16px;
            border-left: 6px solid #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
            transition: transform 0.2s ease-out;
            will-change: transform;
        }

        .task-info { flex: 1; padding-right: 10px; }
        .task-desc { font-size: 16px; font-weight: 500; margin-bottom: 4px; line-height: 1.3; }
        .task-meta { font-size: 11px; color: var(--muted); display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

        /* --- CONTACT BUTTONS --- */
        .contact-btns { display: flex; gap: 10px; margin-left: 10px; align-items: center; }
        .c-btn {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: var(--surface); border: 1px solid var(--border);
            text-decoration: none; font-size: 18px;
        }
        .c-wa { color: #25D366; }
        .c-tel { color: #3498db; }

        /* --- CHECKBOX --- */
        .checkbox-container { width: 30px; height: 30px; flex-shrink: 0; margin-left: 5px; }
        input[type="checkbox"] {
            all: unset !important; width: 26px !important; height: 26px !important;
            background-color: #2a2a2e !important; border: 2px solid var(--border) !important;
            border-radius: 8px !important; position: relative !important; display: block !important;
        }
        input[type="checkbox"]:checked { background-color: var(--accent) !important; border-color: var(--accent) !important; }
        input[type="checkbox"]:checked::after { content: '‚úì' !important; position: absolute !important; color: black !important; font-size: 18px; font-weight: bold; left: 50%; top: 50%; transform: translate(-50%, -50%); }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 500px; left: 50%; transform: translateX(-50%);
            background: var(--surface); border-top: 1px solid var(--border);
            display: flex; padding: 10px 0 calc(10px + var(--safe-bottom)); z-index: 200;
        }
        .nav-item { flex: 1; text-align: center; color: var(--muted); font-size: 10px; font-weight: 600; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 2px; }

        .fab {
            position: fixed; bottom: calc(85px + var(--safe-bottom)); right: 20px;
            width: 60px; height: 60px; background: var(--accent); border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; color: #000; border: none; z-index: 150; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: flex-end; z-index: 1000; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--surface); width: 100%; max-width: 500px; margin: 0 auto; border-radius: 30px 30px 0 0; padding: 30px 25px calc(35px + var(--safe-bottom)); }
        
        .form-row-phone { display: flex; gap: 8px; margin-bottom: 15px; }
        input:not([type="checkbox"]), select, textarea { width: 100%; background: var(--card); border: 1px solid var(--border); color: white; padding: 14px; border-radius: 12px; font-size: 16px; font-family: inherit; }
        .btn-contact-picker { background: var(--border); color: white; border: none; padding: 0 15px; border-radius: 12px; font-size: 20px; cursor: pointer; margin-bottom: 15px; }

        .btn-save { background: var(--accent); color: black; width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: bold; font-size: 17px; cursor: pointer; }

        /* --- UTILS --- */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .cat-card { background: var(--card); border: 1px solid var(--border); padding: 20px 5px; border-radius: 18px; text-align: center; position: relative; }
        .cat-card i { font-size: 28px; display: block; margin-bottom: 8px; }
        .cat-name { font-size: 10px; font-weight: bold; text-transform: uppercase; color: var(--muted); }
        .cat-badge { position: absolute; top: -6px; right: -6px; background: var(--accent); color: #000; font-size: 10px; padding: 2px 7px; border-radius: 10px; border: 2px solid var(--bg); }
        .section-title { font-size: 14px; color: var(--accent); margin: 25px 0 12px; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
        .date-badge { padding: 3px 7px; border-radius: 5px; font-weight: 600; font-size: 10px; background: var(--border); }
        .overdue { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
        .today { background: rgba(245, 166, 35, 0.2); color: #f5a623; border: 1px solid #f5a623; }
        .filter-btn { background: var(--card); border: 1px solid var(--border); color: var(--muted); padding: 8px 18px; border-radius: 20px; font-size: 13px; margin-right: 8px; white-space: nowrap; cursor: pointer; }
        .filter-btn.active { background: var(--accent); color: black; }
    </style>
</head>
<body>

    <header>
        <div class="logo bebas">PROHORECA <span id="header-title" style="color:white; margin-left:10px;">TIMELINE</span></div>
        <div class="header-btns">
            <div class="global-badge" id="total-count" style="background: var(--accent); color: #000; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 12px;">0</div>
            <span onclick="app.showSettings()" style="font-size: 22px; cursor: pointer; padding: 5px;">‚öôÔ∏è</span>
        </div>
    </header>

    <main id="app-shell"></main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="app.setPage('timeline')">
            <span class="nav-icon">üìä</span> TIMELINE
        </div>
        <div class="nav-item" onclick="app.setPage('categories')">
            <span class="nav-icon">üóÇÔ∏è</span> KATEGORIJE
        </div>
        <div class="nav-item" onclick="app.setPage('archive')">
            <span class="nav-icon">‚úÖ</span> ARHIVA
        </div>
    </nav>

    <button class="fab" onclick="ui.openModal()">+</button>

    <!-- MODAL ZADATAK -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h2 class="bebas" id="modal-heading" style="margin-bottom:20px; color:var(--accent);">Zadatak</h2>
            <input type="hidden" id="task-id">
            <input type="text" id="task-desc" placeholder="Opis zadatka...">
            
            <div class="form-row-phone">
                <input type="tel" id="task-phone" placeholder="Broj telefona" style="margin-bottom:0">
                <button class="btn-contact-picker" onclick="app.pickContact()" title="Izaberi iz imenika">üë§</button>
            </div>

            <select id="task-cat" style="margin-bottom:15px;"></select>
            <div style="display:flex; gap:12px;">
                <input type="date" id="task-date" style="flex:1; margin-bottom:15px;">
                <select id="task-priority" style="flex:1; margin-bottom:15px;">
                    <option value="normal">Normalno</option>
                    <option value="hitno">üö® HITNO</option>
                </select>
            </div>
            <button class="btn-save" onclick="app.saveTask()">SAƒåUVAJ</button>
            <button onclick="ui.closeModal()" style="background:none; border:none; color:var(--muted); width:100%; margin-top:15px; cursor:pointer;">Odustani</button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settings-overlay">
        <div class="modal">
            <h2 class="bebas" style="margin-bottom:20px; color:var(--accent);">Pode≈°avanja & Backup</h2>
            <button class="btn-save" onclick="app.exportData()" style="background: #3498db; margin-bottom: 10px;">üì¶ IZVEZI PODATKE</button>
            <button class="btn-save" onclick="document.getElementById('import-file').click()" style="background: #2ecc71;">üì• UƒåITAJ PODATKE</button>
            <input type="file" id="import-file" style="display:none" onchange="app.importData(event)">
            <button onclick="document.getElementById('settings-overlay').classList.remove('open')" style="background:none; border:none; color:var(--muted); width:100%; margin-top:20px; cursor:pointer;">Zatvori</button>
        </div>
    </div>

    <script>
        const CATS = {
            upiti: { n: 'Upiti & Ponude', i: 'üìß', c: '#3498db' },
            projekti: { n: 'Projekti & Monta≈æa', i: 'üèóÔ∏è', c: '#e67e22' },
            obilazak: { n: 'Obilazak', i: 'üöó', c: '#2ecc71' },
            aqua: { n: 'Aqua', i: 'üíß', c: '#00cec9' },
            pv: { n: 'PV', i: '‚òÄÔ∏è', c: '#fdcb6e' },
            finansije: { n: 'Finansije', i: 'üí∞', c: '#f1c40f' },
            privatno: { n: 'Privatno', i: 'üè†', c: '#e84393' },
            dobavljaci: { n: 'Dobavljaƒçi', i: 'üì¶', c: '#9b59b6' },
            vozila: { n: 'Vozni park', i: 'üöö', c: '#e74c3c' },
            opsti: { n: 'Op≈°te', i: 'üìù', c: '#7f8c8d' }
        };

        let tasks = JSON.parse(localStorage.getItem('pro_tasks')) || [];
        let currentPage = 'timeline';
        let currentCat = null;
        let timelineFilter = 'sve';

        const app = {
            setPage(page, cat = null) {
                currentPage = page; currentCat = cat;
                document.querySelectorAll('.nav-item').forEach((el, i) => {
                    el.classList.toggle('active', (page==='timeline' && i===0) || (['categories','category'].includes(page) && i===1) || (page==='archive' && i===2));
                });
                this.render();
            },

            async pickContact() {
                if (!('contacts' in navigator && 'select' in navigator.contacts)) {
                    alert('Va≈° telefon/browser ne podr≈æava direktno biranje kontakata. Molimo unesite broj ruƒçno.');
                    return;
                }
                try {
                    const props = ['name', 'tel'];
                    const contacts = await navigator.contacts.select(props, { multiple: false });
                    if (contacts.length) {
                        const contact = contacts[0];
                        if (contact.tel && contact.tel.length > 0) {
                            document.getElementById('task-phone').value = contact.tel[0];
                            // Ako je opis prazan, stavi ime kontakta
                            if (!document.getElementById('task-desc').value.trim()) {
                                document.getElementById('task-desc').value = contact.name[0];
                            }
                        }
                    }
                } catch (e) { console.log('Biranje kontakta otkazano.'); }
            },

            saveTask() {
                const desc = document.getElementById('task-desc').value.trim();
                const phone = document.getElementById('task-phone').value.trim();
                if (!desc) return;
                const id = document.getElementById('task-id').value;
                const task = {
                    id: id || Date.now().toString(),
                    desc, phone,
                    cat: document.getElementById('task-cat').value,
                    date: document.getElementById('task-date').value,
                    priority: document.getElementById('task-priority').value,
                    done: false
                };
                if (id) {
                    const idx = tasks.findIndex(t => t.id === id);
                    task.done = tasks[idx].done;
                    tasks[idx] = task;
                } else { tasks.push(task); }
                this.sync(); ui.closeModal();
            },

            sync() { localStorage.setItem('pro_tasks', JSON.stringify(tasks)); this.render(); },
            
            render() {
                const shell = document.getElementById('app-shell');
                document.getElementById('total-count').innerText = tasks.filter(t => !t.done).length;
                shell.innerHTML = '';
                if (currentPage === 'timeline') this.renderTimeline(shell);
                else if (currentPage === 'categories') this.renderGrid(shell);
                else if (currentPage === 'category') this.renderCategory(shell);
                else if (currentPage === 'archive') this.renderArchive(shell);
                this.initSwipe();
            },

            renderTimeline(el) {
                const today = new Date().toISOString().split('T')[0];
                let active = tasks.filter(t => !t.done && t.date);
                if(timelineFilter === 'danas') active = active.filter(t => t.date === today);
                if(timelineFilter === 'hitno') active = active.filter(t => t.priority === 'hitno');

                el.innerHTML = `<div style="display:flex; overflow-x:auto; margin-bottom:15px; padding-bottom:5px; scrollbar-width:none;">
                    <div class="filter-btn ${timelineFilter==='sve'?'active':''}" onclick="app.setFilter('sve')">Sve</div>
                    <div class="filter-btn ${timelineFilter==='danas'?'active':''}" onclick="app.setFilter('danas')">Danas</div>
                    <div class="filter-btn ${timelineFilter==='hitno'?'active':''}" onclick="app.setFilter('hitno')">üö® Hitno</div>
                </div>`;

                const overdue = active.filter(t => t.date < today).sort((a,b) => a.date > b.date ? 1 : -1);
                const isToday = active.filter(t => t.date === today);
                const upcoming = active.filter(t => t.date > today).sort((a,b) => a.date > b.date ? 1 : -1);

                if (overdue.length) el.innerHTML += `<div class="section-title bebas">ISTEKLO</div>` + overdue.map(t => this.taskHTML(t)).join('');
                if (isToday.length) el.innerHTML += `<div class="section-title bebas">DANAS</div>` + isToday.map(t => this.taskHTML(t)).join('');
                if (upcoming.length) el.innerHTML += `<div class="section-title bebas">USKORO</div>` + upcoming.map(t => this.taskHTML(t)).join('');
            },

            renderGrid(el) {
                let html = '<div class="grid">';
                for (let k in CATS) {
                    const c = tasks.filter(t => t.cat === k && !t.done).length;
                    html += `<div class="cat-card" onclick="app.setPage('category', '${k}')">${c > 0 ? `<div class="cat-badge">${c}</div>` : ''}<i>${CATS[k].i}</i><div class="cat-name">${CATS[k].n}</div></div>`;
                }
                el.innerHTML = html + '</div>';
            },

            renderCategory(el) {
                const catTasks = tasks.filter(t => t.cat === currentCat && !t.done);
                el.innerHTML = catTasks.length ? catTasks.map(t => this.taskHTML(t)).join('') : '<div style="text-align:center; padding:40px; color:var(--muted)">Prazno.</div>';
            },

            renderArchive(el) {
                const done = tasks.filter(t => t.done);
                el.innerHTML = done.length ? done.slice(-30).reverse().map(t => this.taskHTML(t)).join('') : '<div style="text-align:center; padding:40px; color:var(--muted)">Prazno.</div>';
            },

            taskHTML(t) {
                const today = new Date().toISOString().split('T')[0];
                const ds = t.date < today ? 'overdue' : (t.date === today ? 'today' : '');
                const days = ['Ned', 'Pon', 'Uto', 'Sre', 'ƒået', 'Pet', 'Sub'];
                const dayName = t.date ? `(${days[new Date(t.date).getDay()]})` : '';
                
                // ƒåi≈°ƒáenje broja za WA
                let cleanPhone = t.phone ? t.phone.replace(/[^0-9+]/g, '') : '';
                if (cleanPhone.startsWith('0') && !cleanPhone.startsWith('00')) {
                    cleanPhone = '381' + cleanPhone.substring(1);
                }
                const waLink = `https://wa.me/${cleanPhone}?text=${encodeURIComponent('Podsetnik: ' + t.desc)}`;

                return `
                    <div class="task-container" data-id="${t.id}">
                        <div class="swipe-action swipe-done">GOTOVO ‚úì</div>
                        <div class="swipe-action swipe-delete">OBRI≈†I ‚úï</div>
                        <div class="task-card" style="border-left-color:${CATS[t.cat].c}; opacity:${t.done?0.5:1}" onclick="ui.openModal('${t.id}')">
                            <div class="task-info">
                                <div class="task-desc" style="${t.done?'text-decoration:line-through':''}">${t.desc}</div>
                                <div class="task-meta">
                                    <span style="color:${CATS[t.cat].c}; font-weight:600;">${CATS[t.cat].i} ${CATS[t.cat].n}</span>
                                    ${t.date ? `<span class="date-badge ${ds}">${t.date.split('-')[2]}.${t.date.split('-')[1]}. ${dayName}</span>` : ''}
                                    ${t.priority === 'hitno' ? `<span style="color:#e74c3c; font-weight:bold;">üö® HITNO</span>` : ''}
                                </div>
                            </div>
                            <div class="contact-btns">
                                ${t.phone ? `
                                    <a href="tel:${t.phone}" class="c-btn c-tel" onclick="event.stopPropagation()">üìû</a>
                                    <a href="${waLink}" target="_blank" class="c-btn c-wa" onclick="event.stopPropagation()">üí¨</a>
                                ` : ''}
                                <div class="checkbox-container">
                                    <input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation(); app.toggleTask('${t.id}')">
                                </div>
                            </div>
                        </div>
                    </div>`;
            },

            setFilter(f) { timelineFilter = f; this.render(); },
            toggleTask(id) {
                const t = tasks.find(x => x.id === id);
                if(t) { t.done = !t.done; this.sync(); }
            },
            deleteTask(id) {
                tasks = tasks.filter(t => t.id !== id);
                this.sync();
            },
            showSettings() { document.getElementById('settings-overlay').classList.add('open'); },
            
            exportData() {
                const dataStr = JSON.stringify(tasks);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'pro_backup_' + new Date().toISOString().split('T')[0] + '.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            },

            importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedTasks = JSON.parse(e.target.result);
                        if(Array.isArray(importedTasks)) {
                            if(confirm('Uƒçitati podatke? Ovo ƒáe obrisati trenutne zadatke.')) {
                                tasks = importedTasks;
                                this.sync();
                                document.getElementById('settings-overlay').classList.remove('open');
                            }
                        }
                    } catch(err) { alert('Gre≈°ka pri uƒçitavanju.'); }
                };
                reader.readAsText(file);
            },

            initSwipe() {
                document.querySelectorAll('.task-container').forEach(container => {
                    const card = container.querySelector('.task-card');
                    let startX = 0, currentX = 0;
                    container.addEventListener('touchstart', e => { startX = e.touches[0].clientX; card.style.transition = 'none'; }, {passive: true});
                    container.addEventListener('touchmove', e => {
                        currentX = e.touches[0].clientX - startX;
                        if (currentX > 0) { container.querySelector('.swipe-done').style.opacity = 1; container.querySelector('.swipe-delete').style.opacity = 0; } 
                        else { container.querySelector('.swipe-done').style.opacity = 0; container.querySelector('.swipe-delete').style.opacity = 1; }
                        card.style.transform = `translateX(${currentX}px)`;
                    }, {passive: true});
                    container.addEventListener('touchend', () => {
                        card.style.transition = 'transform 0.3s ease';
                        const id = container.getAttribute('data-id');
                        if (currentX > 130) app.toggleTask(id);
                        else if (currentX < -130) { if(confirm('Obri≈°i?')) app.deleteTask(id); }
                        card.style.transform = `translateX(0px)`;
                        currentX = 0;
                    });
                });
            }
        };

        const ui = {
            openModal(id = null) {
                const catSel = document.getElementById('task-cat');
                catSel.innerHTML = Object.entries(CATS).map(([k,v]) => `<option value="${k}" ${currentCat===k?'selected':''}>${v.i} ${v.n}</option>`).join('');
                if (id) {
                    const t = tasks.find(x => x.id === id);
                    document.getElementById('task-id').value = t.id;
                    document.getElementById('task-desc').value = t.desc;
                    document.getElementById('task-phone').value = t.phone || '';
                    document.getElementById('task-cat').value = t.cat;
                    document.getElementById('task-date').value = t.date;
                    document.getElementById('task-priority').value = t.priority;
                    document.getElementById('modal-heading').innerText = 'Izmeni';
                } else {
                    document.getElementById('task-id').value = '';
                    document.getElementById('task-desc').value = '';
                    document.getElementById('task-phone').value = '';
                    document.getElementById('task-date').value = '';
                    document.getElementById('task-priority').value = 'normal';
                    document.getElementById('modal-heading').innerText = 'Novi zadatak';
                }
                document.getElementById('modal-overlay').classList.add('open');
            },
            closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
        };

        app.render();
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
        }
    </script>
</body>
</html>